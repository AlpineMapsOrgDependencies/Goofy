name: "webassembly"
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: mymindstorm/setup-emsdk@v13
    - uses: actions/checkout@v3
    - uses: bytecodealliance/actions/wasmtime/setup@v1

    - name: Verify emcc
      run: emcc -v

    - name: Set reusable strings
      # Turn repeated input strings (such as the build output directory) into step outputs. These step outputs can be used throughout the workflow file.
      id: strings
      shell: bash
      run: |
        echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

    - name: delete superfluous test data
      run: |
        rm -rf basis
        rm patterns.png
        rm pbr_bricks_albedo.png
        rm pbr_ground_albedo.png
        rm pbr_stones_albedo.png
        rm pbr_stones_normal.png
        rm pbr_head_albedo.png
        rm baboon.png
        rm lena.png
        rm monarch.png
        rm peppers.png
        rm sail.png
        rm tulips.png
        rm kodim01.png
        rm kodim02.png
        rm kodim03.png
        rm kodim04.png
        rm kodim05.png
        rm kodim06.png
        rm kodim07.png
        rm kodim08.png
        rm kodim09.png
        rm kodim10.png
        rm kodim11.png
        rm kodim12.png
        rm kodim13.png
        rm kodim14.png
        rm kodim15.png
        rm kodim16.png
        rm kodim17.png
        rm kodim18.png
        rm kodim19.png
        rm kodim20.png
        rm kodim21.png
        rm kodim22.png
        rm kodim23.png
        rm kodim24.png
        rm roblox01.png
        rm roblox02.png
        rm roblox03.png
        rm roblox04.png
        rm roblox05.png
        rm roblox06.png
      working-directory: ${{ github.workspace }}/test-data

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: >
        emcmake cmake -B ${{ steps.strings.outputs.build-output-dir }}
        -DCMAKE_CXX_COMPILER=emcc
        -DCMAKE_C_COMPILER=emcc
        -DCMAKE_BUILD_TYPE=Release
        -DENABLE_ADDRESS_SANITIZER=ON
        -DENABLE_LONG_TEST_RUN=OFF
        -S ${{ github.workspace }}

    - name: Build
      # Build your program with the given configuration. Note that --config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).
      run: cmake --build ${{ steps.strings.outputs.build-output-dir }} --config Release

    - name: Test on Linux
      working-directory: ${{ github.workspace }}
      # Execute tests defined by the CMake configuration. Note that --build-config is needed because the default Windows generator is a multi-config generator (Visual Studio generator).
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: |
        wasmtime ${{ steps.strings.outputs.build-output-dir }}/bin/GoofyTC.wasm
